#! /bin/bash

# Author		: David Davidson
# Create Date	: 11/23/2011
# Purpose		: Master build script
# Build Platform: Fedora 14 running in Virtual Box 4
# PreReq		: None
# Output		: blue_fire_master.img that can be mounted as a floppy in Bochs (or any vm platform)

# --- Build the binaries ---
echo "Compiling binaries...."
nasm stage1/stage1.asm -o stage1/stage1.bin -l build/stage1.lst
nasm stage2/stage2.asm -i stage2/ -o stage2/stage2.bin -l build/stage2.lst
# debug
# make -C os
dd if=/dev/urandom of=build/bf_kernel32.bin bs=1024 count=1024 

# --- Build the disk ---
# create the final image filled with zeroes
echo "Creating blank image....."
rm -f build/blue_fire_master.img
dd if=/dev/zero of=build/blue_fire_master.img bs=512 count=2880  
#dd if=/dev/zero of=/tmp/blue_fire_master.img bs=512 count=2880

# build the filesystem. Specify 400 file system blocks (800 disk sectors) out of 1440 to leave room for stage2 and the kernel. 
losetup /dev/loop0 build/blue_fire_master.img
# losetup /dev/loop0  /tmp/blue_fire_master.img
echo "Making filesystem (reserved last 1040 sectors)....."
mkfs -v -t ext2 /dev/loop0 400

# write bootloader (stage1) to first sector (0)
dd if=stage1/stage1.bin of=build/blue_fire_master.img conv=notrunc
#dd if=stage1/stage1.bin of=/tmp/blue_fire_master.img conv=notrunc

# write kernel to its reserved space (400K - 1400K) on the disk
dd if=build/bf_kernel32.bin of=build/blue_fire_master.img bs=1024 seek=400 count=1024 conv=notrunc
#dd if=build/bf_kernel32.bin of=/tmp/blue_fire_master.img bs=1024 seek=400 count=1024 conv=notrunc

# write bootstrap (stage2) to the end of the disk
dd if=stage2/stage2.bin of=build/blue_fire_master.img bs=1024 seek=1400 conv=notrunc
#dd if=stage2/stage2.bin of=/tmp/blue_fire_master.img bs=1024 seek=1400 conv=notrunc



# --- Clean up ---
sleep 1
echo "Cleaning Up....."
#mv /tmp/blue_fire_master.img  build/blue_fire_master.img
rm -f stage1/stage1.bin
rm -f stage2/stage2.bin
losetup -d /dev/loop0


