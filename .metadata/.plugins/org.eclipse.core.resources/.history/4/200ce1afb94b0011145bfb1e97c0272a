;**********************************************************
;	bluefire-os
;	Version: 00.00.05
;	Author: David Davidson
;	Name: interrupt_top.asm
;	Last update: 2012-01-30
;	Purpose: holds the entery point of functions called from itd.
;	Usage:
;***********************************************************

%ifndef INTERRUPT_REQUEST_S
%define INTERRUPT_REQUEST_S

%define KERNEL_DATA_SEL 0x08

%macro BUILD_IRQ 1
	push	eax		; Save eax register
	mov	eax, %1		; Put in eax the IRQ number
	jmp	COMMON_ISR
%endmacro

%endif

GLOBAL irq_00, irq_01, irq_06, irq_07
GLOBAL irq_unhand

;Declared in os/kernel/interrupt_handler.c
EXTERN default_handler

irq_00:
	BUILD_IRQ 0x00
irq_01:
	BUILD_IRQ 0x01
irq_06:
	BUILD_IRQ 0x06
irq_07:
	BUILD_IRQ 0x07
irq_unhand:
	BUILD_IRQ 0xFF

COMMON_ISR:
	push	gs
	push	fs
	push	es
	push	ds		; Saving selectors
	pushad			; Saving general purpose registers

	mov	ebx, KERNEL_DATA_SEL
	mov	ds, ebx
	mov	es, ebx
	mov	fs, ebx
	mov	gs, ebx		; Update segment registers

	push	eax		; push IRQ number
	call	default_handler
	pop	eax

	popad			; Restore general purpose registers
	pop	ds
	pop	es
	pop	fs
	pop	gs			; Restore segment registers
	pop	eax			; Restore old eax value
	iretd
