/**************************************************************************
 *	bluefire-os
 *	Version: 00.00.10
 *	Author: David Davidson
 *	Name: dma.c
 *	Created: Feb 14, 2012
 *	Purpose:
 *  Usage:
***************************************************************************/
#include <common_include.h>

// ---------- DMA memory allocator ----------
// DMA free frames stack
u32int *dma_free_frames;
s32int dma_pointer;


u32int dma_pop_frame(){
	u32int ret;

	u32int flags;
	disable_and_save_interrupts(flags);

	if (dma_pointer < (DMA_MEMORY_DIMINSION / PAGE_SIZE)) {
		ret = dma_free_frames[dma_pointer];
		dma_pointer++;
		restore_interrupts(flags);
		return(ret);
	}

	// Out of DMA memory
	restore_interrupts(flags);
	return (NULL);

}

void initialize_DMA(){

	s32int i;
	u32int addr;

	dma_pointer = 0;
	dma_free_frames = (u32int *)kmalloc((DMA_MEMORY_DIMINSION / PAGE_SIZE) * sizeof(u32int));
	for (i=0, addr=(PHYSICAL_DMA_MEMORY_START / PAGE_SIZE); i < (DMA_MEMORY_DIMINSION / PAGE_SIZE); i++, addr++){
			dma_free_frames[i]=addr;
	}
}
